name: Regression
on:
  workflow_dispatch:
  repository_dispatch:
  push:
    branches:
      - '**'
      - '!main'
      - '!feature'
    tags:
      - '**'
    paths-ignore:
      - '**.md'
      - 'tools/**'
      - '!tools/pythonpkg/**'
      - '.github/patches/duckdb-wasm/**'
      - '.github/workflows/**'
      - '!.github/workflows/Regression.yml'

  pull_request:
    types: [opened, reopened, ready_for_review]
    paths-ignore:
      - '**.md'
      - 'tools/**'
      - '!tools/pythonpkg/**'
      - '.github/patches/duckdb-wasm/**'
      - '.github/workflows/**'
      - '!.github/workflows/Regression.yml'


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' || github.sha }}
  cancel-in-progress: true

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  BASE_BRANCH: ${{ github.base_ref || (endsWith(github.ref, '_feature') && 'feature' || 'main') }}

jobs:
 regression-test-plan-cost:
  name: Regression Test Join Order Plan Cost
  runs-on: ubuntu-20.04
  if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
  env:
    CC: gcc-10
    CXX: g++-10
    GEN: ninja
    BUILD_TPCH: 1
    BUILD_HTTPFS: 1

  steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - uses: actions/setup-python@v4
      with:
        python-version: '3.7'

    - name: Regression Test IMDB
      run: |
        python3 scripts/plan_cost_runner.py
#
#    - name: Install
#      shell: bash
#      run: sudo apt-get update -y -qq && sudo apt-get install -y -qq ninja-build && pip install tqdm
#
#    - name: Setup Ccache
#      uses: hendrikmuhs/ccache-action@main
#      with:
#        key: ${{ github.job }}
#        save: ${{ github.ref == 'refs/heads/main' || github.repository != 'duckdb/duckdb' }}
#
#    - name: Build
#      shell: bash
#      run: |
#        make
#        git clone --branch ${{ env.BASE_BRANCH }} https://github.com/duckdb/duckdb.git --depth=1
#        cd duckdb
#        make
#        cd ..
#
#    - name: Set up benchmarks
#      shell: bash
#      run: |
#        cp -r benchmark duckdb/
#
#    - name: Regression Test IMDB
#      continue-on-error: true
#      shell: bash
#      run: |
#        python scripts/plan_cost_runner.py --old=duckdb/build/release/duckdb --new=build/release/duckdb --dir=benchmark/imdb_plan_cost
#
#    - name: Regression Test TPCH
#      continue-on-error: true
#      shell: bash
#      run: |
#        python scripts/plan_cost_runner.py --old=duckdb/build/release/duckdb --new=build/release/duckdb --dir=benchmark/tpch_plan_cost
