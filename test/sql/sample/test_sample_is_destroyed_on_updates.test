# name: test/sql/sample/test_sample_is_destroyed_on_updates.test
# description: Test sampling of larger relations
# group: [sample]

require vector_size 2048

load __TEST_DIR__/test_samples_doot.db

statement ok
create table integers_1 as select range a, range+1 b  from range(5);

query II
select * from pragma_table_sample('integers_1');
----
0	1
1	2
2	3
3	4
4	5

restart

query II
select * from integers_1 order by all;
----
0	1
1	2
2	3
3	4
4	5

query II
select * from pragma_table_sample('integers_1') order by all;
----
0	1
1	2
2	3
3	4
4	5

statement ok
insert into integers_1 VALUES (5, 3);

query II
select * from pragma_table_sample('integers_1') order by all;
----
0	1
1	2
2	3
3	4
4	5
5	3

statement ok
delete from integers_1 where a = 3;

query II
select * from pragma_table_sample('integers_1') order by all;
----

statement ok
create or replace table integers_1 as select range a, range+1 b  from range(5);

query I
select count(*) from pragma_table_sample('integers_1');
----
5

statement ok
update integers_1 set a = 5 where a = 1;

query II
select * from pragma_table_sample('integers_1');
----

# test adding columns destroys the sample.
statement ok
create or replace table integers_1 as select range a, range+1 b  from range(5);

query I
select count(*) from pragma_table_sample('integers_1');
----
5

statement ok
Alter table integers_1 add column c DOUBLE;

query III
select * from pragma_table_sample('integers_1');
----


# test altering types destroys the sample
statement ok
create or replace table integers_1 as select range a, range+1 b  from range(5);

query I
select count(*) from pragma_table_sample('integers_1');
----
5

statement ok
Alter table integers_1 alter b TYPE VARCHAR

query II
select * from pragma_table_sample('integers_1');
----

# test dropping a columns
statement ok
create or replace table integers_1 as select range a, range+1 b  from range(5);

query I
select count(*) from pragma_table_sample('integers_1');
----
5

statement ok
Alter table integers_1 drop b;

query I
select * from pragma_table_sample('integers_1');
----


# test sample is destroyed after a restart
statement ok
create or replace table integers_1 as select range a, range+1 b  from range(500);

query I
select count(*) from pragma_table_sample('integers_1');
----
500

statement ok
Alter table integers_1 drop b;

# sample is destroyed
query I
select * from pragma_table_sample('integers_1');
----

restart

statement ok
insert into integers_1 select range a from range(500);

# sample is still destroyed
query I
select * from pragma_table_sample('integers_1');
----




