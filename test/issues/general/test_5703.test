# name: test/issues/general/test_5703.test
# description: Issue 5703: Can't have a window aggregate and unnest.
# group: [general]

statement error
select unnest([5,4,3]) as r, sum(r) OVER () + 42;
----
Binder Error

statement error
select sum(unnest([1,2,3])) over ();
----
Binder Error

# can still perform other functions over unnest alias
query II
select unnest([1, 2, 3]) as r, r + 1;
----
1	2
2	3
3	4

statement error
select unnest([5,4,3]) as r, sum(r) OVER ();
----
Binder Error

statement ok
select unnest([5,4,3]) as r, sum(42) OVER ();

# unnest hiding behind two aliases is not ok
statement error
SELECT unlist(str_split('A',' ')) AS "r", CASE WHEN ("r" = 'A') THEN (-1) ELSE 0 END AS "x", sum("x") OVER () AS "s";
----
Binder Error

# our unnest_index logic is not disturbed by other select nodes in the select list. 
statement error
SELECT unlist(str_split('A',' ')) AS "r", 5, 6, CASE WHEN ("r" = 'A') THEN (-1) ELSE 0 END AS "x", sum("x") OVER () AS "s";
----
Binder Error


# row numbers are ok
statement ok
select unnest([5,4,3]) as r, row_number() OVER (partition by (SELECT NULL));

statement ok
select tmp.r, sum(tmp.r) OVER () + 42 FROM (select unnest([5, 4, 3]) as r) tmp;

# row numbers are ok
statement ok
select unnest([5,4,3]) as r, row_number() OVER (partition by (SELECT NULL));

statement error
select unnest([5,4,3]) as r, lead(r, 1) OVER (partition by (SELECT NULL));
----
Binder Error

statement error
select unnest([5,4,3]) as r, FIRST_VALUE(r) OVER ();
----
Binder Error

statement error
select unnest([5,4,3]) as r, LAST_VALUE(r) OVER ();
----
Binder Error

statement error
select unnest([5,4,3]) as r, LAG(r, 1) OVER ();
----
Binder Error

statement error
select unnest([5,4,3]) as r, NTH_VALUE(r, 1) OVER ();
----
Binder Error

statement error
select unnest([5,4,3]) as r, dense_rank(r) OVER ();

query II
select unnest([5,4,3]) as r, NTILE(3) OVER ();
----
5	1
4	1
3	1

statement error
select unnest([5,4,3]) as r, NTILE(1) OVER (ORDER BY r);
----
Binder Error

statement error
select unnest([5,4,3]) as r, sum(r + 42) OVER ();
----
Binder Error

statement ok
select unnest([5, 4, 3]), sum(41) over ();

statement error
select unnest([5,4,3]) as r, sum(r + 42) OVER ();
----
Binder Error

statement error
select sum(unnest([1,2,3])) over ();
----
Binder Error
