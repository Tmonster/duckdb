# name: test/optimizer/pushdown/parquet_or_pushdown.test
# description: Test Parquet With Pushing Down of OR Filters
# group: [pushdown]

require parquet

statement ok
PRAGMA enable_verification

#statement ok
#copy (select range as a, (range % 3 == 0)::BOOL as b from range(100)) to '__TEST_DIR__/parquet_or_filter.parquet' (FORMAT PARQUET);  

# Multiple column in the root OR node, don't push down
query II
SELECT tbl.a, tbl.b FROM 'delete_me.parquet' tbl(a, b) WHERE a = 2 or a = 5 or a = 9 order by a;
----
2	false
5	false
9	true

mode skip

# Single column in the root OR node
query II
EXPLAIN SELECT tbl.a FROM "data/parquet-testing/arrow/alltypes_plain.parquet" tbl(a) WHERE a=1 OR a=2
----
physical_plan	<REGEX>:.*PARQUET_SCAN.*Filters: a=1 OR a=2.*

# Single column + root OR node with AND
query II
EXPLAIN SELECT tbl.a FROM "data/parquet-testing/arrow/alltypes_plain.parquet" tbl(a) WHERE a=1 OR (a>3 AND a<5)
----
physical_plan	<REGEX>:.*PARQUET_SCAN.*Filters: a=1 OR a>3 AND a<5|.*


# Single column multiple ORs
query II
EXPLAIN SELECT tbl.a FROM "data/parquet-testing/arrow/alltypes_plain.parquet" tbl(a) WHERE a=1 OR a>3 OR a<5
----
physical_plan	<REGEX>:.*PARQUET_SCAN.*Filters: a=1 OR a>3 OR a<5|.*



# Testing not equal
query II
EXPLAIN SELECT tbl.a FROM "data/parquet-testing/arrow/alltypes_plain.parquet" tbl(a) WHERE a!=1 OR a>3 OR a<2
----
physical_plan	<REGEX>:.*PARQUET_SCAN.*Filters: a!=1 OR a>3 OR a<2|.*


# Multiple OR filters connected with ANDs
query II
EXPLAIN SELECT tbl.a, tbl.b, tbl.c FROM "data/parquet-testing/arrow/alltypes_plain.parquet" tbl(a,b,c) WHERE (a<2 OR a>3) AND (a=1 OR a=4) AND (b=false OR c=1);
----
physical_plan	<REGEX>:.*PARQUET_SCAN.*Filters: a<2 OR a>3 AND a=1.*OR a=4.*


# Testing the number of rows filtered (column "a" has eight values: 0 .. 7)
statement ok
PRAGMA enable_profiling

# should return 2 rows: 0 and 7
query II
EXPLAIN ANALYZE SELECT tbl.a FROM "data/parquet-testing/arrow/alltypes_plain.parquet" tbl(a) WHERE a<1 OR a>6;
----
analyzed_plan	<REGEX>:.*PARQUET_SCAN.*Filters: a<1 OR a>6.*2[ \t].*

# should return 1 row: 0
query II
EXPLAIN ANALYZE SELECT tbl.a FROM "data/parquet-testing/arrow/alltypes_plain.parquet" tbl(a) WHERE a<1 OR a>8;
----
analyzed_plan	<REGEX>:.*PARQUET_SCAN.*Filters: a<1 OR a>8.*1[ \t].*
