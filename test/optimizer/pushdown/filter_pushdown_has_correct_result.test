# name: test/optimizer/pushdown/filter_pushdown_has_correct_result.test
# description: Test Table Filter Push Down
# group: [pushdown]

statement ok
CREATE TABLE Accounts_timeshift(
ts_start TIMESTAMP WITH TIME ZONE DEFAULT('0002-02-02'), 
ts_deleted BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)), 
id VARCHAR,
num_employees INTEGER,
aggr INTEGER,
aggr_group INTEGER);

statement ok
Insert into Accounts_timeshift select now() ts_start, true ts_deleted, range::VARCHAR id, range*random() num_employees, range%20 aggr, range%300 aggr_group from range(50000);


statement ok
WITH combined_table AS (
  SELECT * from Accounts_timeshift
  UNION
  SELECT * FROM Accounts_timeshift
), aggregated_table AS (
  	SELECT id, ts_start, ts_deleted, sum(aggr), num_employees from combined_table group by all
), time_partitioned_table AS (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY ts_start DESC) AS row_number
    FROM aggregated_table
) , final_table AS (
  SELECT * EXCLUDE (row_number) FROM time_partitioned_table
)
SELECT id, num_employees from final_table where id = 'BP3wDgRb98EuHxg' AND num_employees > 550;

